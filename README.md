# llama2-train-from-scratch
Train a LLamA2 model from scratch and convert it into GGUF format

The goal of this project is to learn about Llama2 architecture from Facebook, run it, train a very simple model locally, and then get it to run inside the llama.cpp framework.


## Setup

### prepare virtual env
#### uv install

```
# On macOS and Linux.
curl -LsSf https://astral.sh/uv/install.sh | sh

# On Windows.
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"

# With pip.
pip install uv

# With pipx.
pipx install uv

# With Homebrew.
brew install uv

# With Pacman.
pacman -S uv
```

#### create venv
```
uv venv

source .venv/bin/activate
```

### install packages

```
# meta Llama2
uv pip install -e.
```



## Prepare dataset

### Tiny Shakespeare


```

python tinyshakespeare.py prepare

# output
Example story :
 ['First Citizen:', 'Before we proceed any further, hear me speak.', 'All:', 'Speak, speak.', 'First Citizen:', 'You are all resolved rather to die than to famish?', 'All:', 'Resolved. resolved.', 'First Citizen:', 'First, you know Caius Marcius is chief enemy to the people.']

```


### Prachathai67k

```
python prepare_thai_dataset.py download

#output
inflating: data/prachathai67k/data/train.jsonl  
  inflating: data/prachathai67k/data/test.jsonl  
  inflating: data/prachathai67k/data/valid.jsonl  
Download done.
Number of shards: 3
Example story:
{'url': 'https://prachatai.com/print/62490', 'date': '2015-11-17 18:14', 'title': 'แฮคเกอร์ Anonymous ลั่นทำสงครามไซเบอร์ครั้งใหญ่สุดกับกลุ่ม IS', 'body_text': '17 พ.ย. 2558 Blognone [1] รายงานว่า กลุ่มแฮคเกอร์ Anonymous ประกาศสงครามไซเบอร์กับกลุ่มหัวรุนแรงหลังจากกลุ่ม IS ออกมาประกาศว่าเป็นผู้อยู่เบื้องหลังการโจมตีกรุงปารีสในคืนวันศุกร์ที่ผ่านมา\n\n\nภาพในคลิปใน YouTube โฆษกของกลุ่มแฮคเกอร์สวมหน้ากากที่เป็นสัญลักษณ์ของกลุ่มได้ออกมาอ่านแถลงเป็นภาษาฝรั่งเศส มีใจความว่า จากการโจมตีของกลุ่ม IS ในกรุงปารีส กลุ่ม Anonymous ทั่วโลกจะตามล่ากลุ่ม IS เหมือนที่เคยทำตอนที่มีการโจมตีสำนักพิมพ์ Charlie Hebdo และครั้งนี้จะเป็นปฏิบัติการโจมตีครั้งใหญ่ที่สุดของกลุ่ม Anonymous เลย นอกจากนี้กลุ่ม Anonymous ยังแสดงความเสียใจต่อครอบครัวผู้สูญเสียในเหตุการณ์ครั้งนี้\nกลุ่ม Anonymous เคยประกาศสงครามกับกลุ่ม IS หลังจากการโจมตีสำนักพิมพ์ Charlie Hebdo ที่ฝรั่งเศสเมื่อต้นปีที่ผ่านมา ซึ่งครั้งนั้นกลุ่ม Anonymous อ้างว่าได้ระงับบัญชีผู้ใช้งานที่เกี่ยวข้องกับ IS ไปหลายพันบัญชี (อ่านรายละเอียดเพิ่มเติม จากBlognone ที่\xa0\xa0กลุ่มแฮคเกอร์ Anonymous ประกาศสงครามไซเบอร์ขอกวาดล้างพวก ISIS [2])', 'politics': 0, 'human_rights': 0, 'quality_of_life': 0, 'international': 1, 'social': 0, 'environment': 0, 'economics': 0, 'culture': 0, 'labor': 0, 'national_security': 0, 'ict': 1, 'education': 0}
```

```
python prepare_thai_data.py prepare

#output
Number of train samples : 61100
Number of test samples : 6789
Train sample : 
	วุฒิสภาจี้หาทางออกเหมืองโปแตช ประชาไท9 ก.พ. 2549 เมื่อวันที่ 8 ก.พ. เวลาประมาณ 14.00 น. คณะกรรมาธิการสิ่งแวดล้อมวุฒิสภาได้จัดเวทีประชุมติดตามความคืบหน้าโครงการเหมืองแร่โปแตช จ. อุดรธานี เนื่องจากเห็นว่ามีการผลักดันโครงการอย่างเร่งด่วนโดยไม่คำนึงถึงการมีส่วนร่วมของประชาชนในพื้นที่ ณ ห้องประชุมกรรมาธิการหมายเลข 306 อาคารรัฐสภาตามข้อเรียกร้องของกลุ่มอนุรักษ์สิ่งแวดล้อมอุดรธานี โดยได้เชิญหน่วยงานที่เกี่ยวข้องได้แก่ กรมอุตสาหกรรมพื้นฐานและการเหมืองแร่ สำนักงานนโยบายและแผนทรัพยากรธรรมชาติสิ่งแวดล้อม กลุ่มอนุรักษ์สิ่งแวดล้อมอุดรธานี เข้ามาชี้แจงให้ข้อมูล      นายสุรพงษ์ เชียงทอง เจ้าหน้าที่กรมอุตสาหกรรมพื้นฐานและการเหมืองแร่ (กพร.) รายงานต่อที่ประชุมว่าขณะนี้บริษัทได้ยื่นขอประธานบัตรทำเหมืองแล้วอยู่ระหว่างการขึ้นรูปแผนที่พื้นที่ทำเหมืองใต้ดิน ในขณะนี้ทางบริษัทต้องทำการรังวัดปักหมดเขตที่ตั้งโรงแยกแร่ หรือเหมืองแร่บนดินและขึ้นรูปแผนที่เพื่อจะได้ติดประกาศในท้องถิ่นก่อนที่อธิบดีกพร.จะรับรอง แต่อย่างไรก็ตามขณะนี้บริษัยยังไม่ได้ยื่นเอกสารเพื่อการพิจารณาเข้ามาอย่างครบถ้วน และยังต้องดำเนินการอีกหลายขั้นตอนตามกฎหมายแร่ฉบับปี 2545        นายแก้วสรร อติโพธิ ประธานกรรมาธิการสิ่งแวดล้อมวุฒิสภา กล่าวว่าจาการที่เจ้าหน้าที่จากสำนักงานนโยบายและแผนทรัพยากรธรรมชาติและสิ่งแวดล้อม(สผ.)รายงานต่อที่ประชุมว่าคณะนี้บริษัทยังไม่ได้ส่งรายงานฉบับใหม่ที่ต้องมีรายละเอียดเรื่องการศึกษาวิเคราะห์ผลกระทบตามสารสำคัญของกฎหมายแร่ฉบับใหม่ที่ครอบคลุมการทำเหมืองแร่ใต้ดินให้ สผ.พิจารณา อย่างไรก็ตามในการพิจารณาของ สผ. ซึ่งเป็นหน่วยงานราชการมีอำนาจจะตั้งคำถามทางเทคนิควิธีการเพื่อสร้างทางเลือก เช่น การทำเหมืองแร่ใต้ดินแบบที่บริษัทเสนอเป็นแบบช่องทางสลับค้ำยันนี้ปลอดภัยจริงหรือไม่เมื่อเหมืองอยู่ใต้ชุมชน มีทางเลือกวิธีการทำเหมืองใต้ดินแบบที่ปลอดภัยกว่านี้เช่นแบบเหมืองละลายแร่ (Solution mining) เรื่อง กองหางแร่ไม่ต้องพิจารณาเพียงว่าจะใช้ผ้ายางหนาเท่าใดหรือมีผู้เชี่ยวชาญหรือไม่เมื่อนำเอาเกลือปริมาณมากกองบนผิวดินมันจะต้องมีผลกระทบแน่ ๆ ทางกรรมาธิการเป็นห่วงเรื่องนี้มาก จะต้องชี้แจงให้บริษัทแก้ไข การนำเกลือลงไปถมกลับนั้นเราก็รู้กันอยู่ว่าเกลือมีราคาและการนำกลับลงไปก็มีค่าใช้จ่าย และทั้ง สผ. และ กพร. ต่างมีความเห็นพ้องกันว่าสามารถนำไปใช้ในอุตสาหกรรมต่อเนื่องได้ บริษัทจะต้องชี้แจงให้ชัดเจนในรายงานว่าเกลือจะขายให้อุตสาหกรรมต่อเนื่องหรือจะถมกลับ        นายแก้วสรร ยังกล่าวอีกว่าแม้บริษัทจะยื่นขอประทานบัตรเป็นบริเวณกว้าง 2 แหล่งมีชุมชนหลายชุมชนตั้งอยู่ข้างบน กพร.ก็ไม่จำเป็นต้องอนุญาตทั้งหมดที่บริษัทขอ มันขึ้นอยู่ที่การพิจารณาของ กพร. จะเป็นไปได้หรือไม่ที่จะละเว้นเขตที่มีชุมชนตั้งอยู่ และทางจังหวัดจะต้องจัดทำแผนที่แสดงความหนาแน่นของประชากรให้ชัดเจนว่าเขตนี้มีประชากรอยู่เท่าไหร่ ถ้ามีประชากรอยู่ก็ละเว้นไม่อนุญาตให้ทำ เพราะหน่วยงานราชการต้องสร้างทางเลือกที่เหมาะสม  ลดความขัดแย้งเพราะถ้าสร้างเหมืองแร่บนความขัดแย้ง  ในชุมชนก็ไม่มีวันสงบ หากชุมชนไม่ยอมรับเหมือนกรณีโครงการท่อก๊าซไทยมาเลเซีย ที่สร้างบนความขัดแย้งปัจจุบันโครงการก็อยู่อย่างหวาดผวาว่าจะมีคนมาวางระเบิดเมื่อไร นายแก้วสรรกล่าว        ด้านพลเอกสมคิด ศรีสังคม สว.อุดรธานี กล่าวว่า สิ่งที่น่าห่วงหากเกิดโครงการคือเรื่องผลกระทบจากเกลือหางแร่เพราะภาคอีสานลมแรงในฤดูแล้ง พายุฤดูแล้งลมแรงมาก ขณะที่ฤดูฝนก็มีฝนมาก ที่ตั้งโครงการก็เช่นกันโรงแต่งแร่ตั้งอยู่บนเนินสูง กองเกลือกว้างเป็นกิโล และสูง 40 เมตรไม่ต้องใช้ผู้เชี่ยวชาญพิจารณาให้ลำบากก็เห็นว่าจะมีผลกระทบอยู่ชัด ๆ ในฐานะคนอุดรธานีผมไม่เห็นด้วยกับโครงการไม่อยากให้สร้างเหมืองแร่ในจังหวัดอุดรธานี        ด้านนางมณี บุญรอด  รองประธานกลุ่มอนุรักษ์สิ่งแวดล้อมอุดรธานี กล่าวชี้แจงว่าปัจจุบันชาวบ้านไม่ยอมรับโครงการและมีการทำงานแย่งแยกชาวบ้าน เกิดความขัดแย้งรุนแรงขึ้นเรื่อย ๆ แม้ยังไม่สร้างโครงการ คือสิ่งที่น่าเป็นห่วงที่สุด และหากโครงการยังดำรงอยู่ความขัดแย้งก็รุนแรงขึ้นเรื่อย ๆ แม้บริษัทจะอ้างว่าได้ลงทุนไปแล้วหลายพันล้าน รวมทั้งบริษัทอ้างว่าจะฟ้องร้องรัฐบาลไทยหากไม่ได้ทำเหมือง และจะเป็นการทำลายความเชื่อมั่นคงนักลงทุนต่างชาติ  นั้นเป็นการพูดแต่ได้เพราะบริษัทเองละเลยขั้นตอนกฎหมายไทย ละเมิดสิทธิคนไทย  และกำลังมีการยุแยงให้คนไทย คนในชุมชนเดียวกันขัดแย้งเข่นฆ่ากันเอง politics

Test sample : 
	แฮคเกอร์ Anonymous ลั่นทำสงครามไซเบอร์ครั้งใหญ่สุดกับกลุ่ม IS 17 พ.ย. 2558 Blognone [1] รายงานว่า กลุ่มแฮคเกอร์ Anonymous ประกาศสงครามไซเบอร์กับกลุ่มหัวรุนแรงหลังจากกลุ่ม IS ออกมาประกาศว่าเป็นผู้อยู่เบื้องหลังการโจมตีกรุงปารีสในคืนวันศุกร์ที่ผ่านมา   ภาพในคลิปใน YouTube โฆษกของกลุ่มแฮคเกอร์สวมหน้ากากที่เป็นสัญลักษณ์ของกลุ่มได้ออกมาอ่านแถลงเป็นภาษาฝรั่งเศส มีใจความว่า จากการโจมตีของกลุ่ม IS ในกรุงปารีส กลุ่ม Anonymous ทั่วโลกจะตามล่ากลุ่ม IS เหมือนที่เคยทำตอนที่มีการโจมตีสำนักพิมพ์ Charlie Hebdo และครั้งนี้จะเป็นปฏิบัติการโจมตีครั้งใหญ่ที่สุดของกลุ่ม Anonymous เลย นอกจากนี้กลุ่ม Anonymous ยังแสดงความเสียใจต่อครอบครัวผู้สูญเสียในเหตุการณ์ครั้งนี้ กลุ่ม Anonymous เคยประกาศสงครามกับกลุ่ม IS หลังจากการโจมตีสำนักพิมพ์ Charlie Hebdo ที่ฝรั่งเศสเมื่อต้นปีที่ผ่านมา ซึ่งครั้งนั้นกลุ่ม Anonymous อ้างว่าได้ระงับบัญชีผู้ใช้งานที่เกี่ยวข้องกับ IS ไปหลายพันบัญชี (อ่านรายละเอียดเพิ่มเติม จากBlognone ที่  กลุ่มแฮคเกอร์ Anonymous ประกาศสงครามไซเบอร์ขอกวาดล้างพวก ISIS [2]) international ict

```



## Tokenization

### Tiny Shakespeare

```
python tinyshakespeare.py pretokenize
```

### Prachathai67k


```
python prepare_thai_data.py pretokenize

# output
Saved data/prachathai67k/test.bin, average seqlen: 5961.4124
Saved data/prachathai67k/train.bin, average seqlen: 5866.3181

```
I have trained two different models using two different datasets. 
Datasets :
1. Tiny Shakespeare
2. prachathai67k


## Training a Model

Most of the code are from llama2.c. 

- download dataset
- prepare dataset
- tokenize dataset
- tokenizer model (Llama2 tokenizer)
- model parameter

## Converting to other formats
- export to llama2 .bin
- export to ggml
- export to gguf

## Text Generation
- text generation in llama2.c 
- text generation in pytorch llama
- text generation in ggml format
- text generation in gguf format
